<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Per-Tab Audio Control</title>
  <!-- Modular CSS - load order: base → tab → volume → presets → effects → controls -->
  <link rel="stylesheet" href="popup-base.css">
  <link rel="stylesheet" href="popup-tab.css">
  <link rel="stylesheet" href="popup-volume.css">
  <link rel="stylesheet" href="popup-presets.css">
  <link rel="stylesheet" href="popup-effects.css">
  <link rel="stylesheet" href="popup-controls.css">
  <link rel="stylesheet" href="popup-seekbar.css">
</head>
<body class="initializing">
  <div class="container">
    <header class="header">
      <!-- 1. Brand Logo -->
      <a data-header-item="companyLogo" href="https://afterbedtimecreations.com" target="_blank" rel="noopener noreferrer" class="brand-logo-link" title="Visit After Bedtime Creations">
        <div class="brand-logo">
          <!-- Dark mode logo -->
          <svg class="logo-dark" width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="After Bedtime Creations">
            <rect x="10" y="10" width="80" height="80" rx="8" stroke="#5a7a9a" stroke-width="5" fill="#0f172a"/>
            <line x1="50" y1="10" x2="50" y2="90" stroke="#5a7a9a" stroke-width="3"/>
            <line x1="10" y1="50" x2="90" y2="50" stroke="#5a7a9a" stroke-width="3"/>
            <rect x="53" y="53" width="34" height="34" rx="3" fill="#d4c78a"/>
            <text x="30" y="38" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#c9a0a0" text-anchor="middle">A</text>
            <text x="70" y="38" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#a0c9a8" text-anchor="middle">B</text>
            <text x="30" y="78" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#a0b8c9" text-anchor="middle">C</text>
            <path d="M61 66 L61 74 L65 74 L71 78 L71 62 L65 66 Z" fill="#0f172a"/>
            <path d="M74 66 Q78 70 74 74" stroke="#0f172a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
            <path d="M77 63 Q83 70 77 77" stroke="#0f172a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
          </svg>
          <!-- Light mode logo -->
          <svg class="logo-light" width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="After Bedtime Creations">
            <rect x="10" y="10" width="80" height="80" rx="8" stroke="#8a7a6a" stroke-width="5" fill="#faf5ef"/>
            <line x1="50" y1="10" x2="50" y2="90" stroke="#8a7a6a" stroke-width="3"/>
            <line x1="10" y1="50" x2="90" y2="50" stroke="#8a7a6a" stroke-width="3"/>
            <rect x="53" y="53" width="34" height="34" rx="3" fill="#c4a870"/>
            <text x="30" y="38" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#a07070" text-anchor="middle">A</text>
            <text x="70" y="38" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#70a078" text-anchor="middle">B</text>
            <text x="30" y="78" font-family="Comfortaa, sans-serif" font-size="20" font-weight="600" fill="#7088a0" text-anchor="middle">C</text>
            <path d="M61 66 L61 74 L65 74 L71 78 L71 62 L65 66 Z" fill="#faf5ef"/>
            <path d="M74 66 Q78 70 74 74" stroke="#faf5ef" stroke-width="2.5" stroke-linecap="round" fill="none"/>
            <path d="M77 63 Q83 70 77 77" stroke="#faf5ef" stroke-width="2.5" stroke-linecap="round" fill="none"/>
          </svg>
        </div>
      </a>
      <!-- 2. Spacer (locked - between logo and brand text) -->
      <div data-header-item="spacer1" class="header-spacer" aria-hidden="true"></div>
      <!-- 3. Brand Text -->
      <span data-header-item="brandText" class="brand-text"><span>After Bedtime</span><span>Creations</span></span>
      <!-- 3. Audio Mode Toggle (cycles: Tab Capture → Web Audio → Disable) -->
      <button data-header-item="audioMode" class="header-btn audio-mode-toggle" id="audioModeToggle" title="Tab Capture mode (click to switch)" aria-label="Audio mode toggle">
        <!-- Tab Capture icon -->
        <svg class="mode-icon mode-tabcapture" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="7" y="7" width="10" height="10" rx="1" stroke="currentColor" stroke-width="2"/>
        </svg>
        <!-- Web Audio icon -->
        <svg class="mode-icon mode-webaudio" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 12h2l2-4 3 8 3-8 2 4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <!-- Disable icon -->
        <svg class="mode-icon mode-off" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
          <line x1="5.5" y1="5.5" x2="18.5" y2="18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <!-- 5. Focus (mute other tabs) -->
      <button data-header-item="focus" class="header-btn" id="focusBtn" title="Focus: Mute other tabs" aria-label="Focus: Mute other tabs">
        <!-- Center focus icon with concentric rings -->
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke-width="1.5" opacity="0.5"/>
          <circle cx="12" cy="12" r="7" stroke-width="1.5" opacity="0.7"/>
          <circle cx="12" cy="12" r="4" stroke-width="1.5" opacity="0.9"/>
          <circle cx="12" cy="12" r="2" fill="currentColor" stroke="none"/>
        </svg>
      </button>
      <!-- 7. Basic/Advanced Mode Toggle -->
      <button data-header-item="modeToggle" class="header-btn mode-toggle" id="modeToggle" title="Switch to Basic mode" aria-label="Toggle Basic/Advanced mode">
        <!-- Basic mode icon: single line -->
        <svg class="icon-basic" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <!-- Advanced mode icon: three lines -->
        <svg class="icon-advanced" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="4" y1="7" x2="20" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="17" x2="20" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <!-- 8. Theme -->
      <button data-header-item="theme" class="header-btn" id="themeToggle" title="Toggle morning/bedtime" aria-label="Toggle morning/bedtime">
        <svg class="icon-sun" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
          <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg class="icon-moon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <!-- 9. Settings -->
      <button data-header-item="settings" class="header-btn" id="settingsBtn" title="Settings" aria-label="Open settings">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <!-- 10. Volume Icon -->
      <div data-header-item="logo" class="logo" id="volumeLogo" title="Volume level indicator" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 28 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path class="speaker-icon" d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Mute X - only shown when muted -->
          <g class="mute-x">
            <line x1="18" y1="9" x2="14" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="14" y1="9" x2="18" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </g>
          <!-- Wave 1: 1-50% (closest to speaker) -->
          <path class="volume-wave wave-1" d="M14.5 10C15.1 10.7 15.5 11.3 15.5 12C15.5 12.7 15.1 13.3 14.5 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Wave 2: 51-100% -->
          <path class="volume-wave wave-2" d="M16.5 8.5C17.5 9.5 18 10.7 18 12C18 13.3 17.5 14.5 16.5 15.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Wave 3: 101-200% -->
          <path class="volume-wave wave-3" d="M18.5 7C19.8 8.3 20.5 10.1 20.5 12C20.5 13.9 19.8 15.7 18.5 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Wave 4: 201-350% -->
          <path class="volume-wave wave-4" d="M20.5 5.5C22.2 7.2 23 9.5 23 12C23 14.5 22.2 16.8 20.5 18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Wave 5: 351-500% (ultra) -->
          <path class="volume-wave wave-5" d="M22.5 4C24.5 6 25.5 8.8 25.5 12C25.5 15.2 24.5 18 22.5 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </header>

    <div class="tab-info-wrapper">
      <div class="tab-info">
        <canvas id="visualizer" class="visualizer-canvas" title="Click: Go to tab | Long-press: Change style" aria-label="Audio visualizer - click to go to tab, long-press to change style" role="img"></canvas>
        <div class="tab-title" id="tabTitle" aria-live="polite">Loading...</div>
        <div class="tab-url" id="tabUrl" aria-live="polite"></div>
        <div class="tab-counter" id="tabCounter" aria-live="polite" aria-atomic="true"></div>
        <div class="visualizer-unavailable" id="visualizerUnavailable" title="Audio not accessible to visualizer" aria-label="Visualizer unavailable - audio not accessible">
          <span>Visualizer</span>
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <circle cx="12" cy="12" r="10"/>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
          </svg>
        </div>
        <div class="visualizer-off" id="visualizerOff" title="Click visualizer to change style" aria-label="Visualizer off - click to change style">
          <span>Visualizer</span>
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <path d="M17 7L7 17M7 7l10 10"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="tab-title-external" id="tabTitleExternal"></div>

    <div class="seekbar-row" id="seekbarRow" role="group" aria-label="Playback position">
      <span class="seekbar-time" id="seekbarCurrentTime">0:00</span>
      <div class="seekbar-track-wrapper">
        <div class="seekbar-track">
          <div class="seekbar-fill" id="seekbarFill"></div>
        </div>
        <input
          type="range"
          id="seekbarSlider"
          min="0"
          max="100"
          value="0"
          step="0.1"
          class="seekbar-slider"
          title="Drag to seek"
          aria-label="Playback position slider"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="0"
        >
      </div>
      <span class="seekbar-time" id="seekbarDuration">0:00</span>
    </div>

    <div class="volume-row" role="group" aria-label="Volume controls">
      <div class="volume-left">
        <button class="tab-nav-btn" id="mediaToggleBtn" title="Toggle play/pause" aria-label="Toggle play/pause">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polygon points="6 3 20 12 6 21 6 3"></polygon>
          </svg>
        </button>
        <button class="tab-nav-btn" id="prevTabBtn" title="Previous audio tab (Left arrow)" aria-label="Previous audio tab" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button class="volume-adjust-btn" id="volumeDown" title="Decrease 1%" aria-label="Decrease volume by 1%">−</button>
      </div>
      <span class="volume-value" id="volumeValue" aria-live="polite" aria-atomic="true">100</span>
      <div class="volume-right">
        <button class="volume-adjust-btn" id="volumeUp" title="Increase 1%" aria-label="Increase volume by 1%">+</button>
        <button class="tab-nav-btn" id="nextTabBtn" title="Next audio tab (Right arrow)" aria-label="Next audio tab" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
        <button class="tab-nav-btn" id="resetTabBtn" title="Reset tab to defaults" aria-label="Reset current tab to default settings">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M1 4v6h6"/>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
          </svg>
        </button>
      </div>
      <div class="disabled-status" id="disabledStatus" role="status" aria-live="polite"></div>
    </div>

    <div class="slider-container">
      <div class="slider-track">
        <div class="slider-fill" id="sliderFill"></div>
        <div class="slider-markers" aria-hidden="true">
          <span class="marker" data-value="0">0</span>
          <span class="marker marker-linear-only" data-value="25">25</span>
          <span class="marker" data-value="50">50</span>
          <span class="marker marker-linear-only" data-value="75">75</span>
          <span class="marker" data-value="100">100</span>
          <span class="marker" data-value="300">300</span>
          <span class="marker" data-value="500">500</span>
        </div>
      </div>
      <input
        type="range"
        id="volumeSlider"
        min="0"
        max="100"
        value="50"
        step="0.5"
        class="volume-slider"
        title="Drag to adjust volume (0-500%)"
        aria-label="Volume slider"
        aria-valuemin="0"
        aria-valuemax="500"
        aria-valuenow="100"
      >
    </div>

    <div class="presets" role="group" aria-label="Volume presets">
      <button class="preset-btn" data-volume="0" id="muteBtn" title="Mute audio (0%)" aria-label="Mute audio" aria-pressed="false">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="23" y1="9" x2="17" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="17" y1="9" x2="23" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Mute
      </button>
      <button class="preset-btn reduced" data-volume="25" title="Reduced volume" aria-label="Set volume to 25%">25%</button>
      <button class="preset-btn boost" data-volume="100" title="Normal volume" aria-label="Set volume to 100%">100%</button>
      <button class="preset-btn high" data-volume="200" title="High boost" aria-label="Set volume to 200%">200%</button>
      <button class="preset-btn extreme" data-volume="300" title="Extreme boost" aria-label="Set volume to 300%">300%</button>
      <button class="preset-btn ultra" data-volume="500" title="Maximum boost" aria-label="Set volume to 500%">500%</button>
    </div>

    <!-- Native mode status message (full width, below presets) -->
    <div class="native-mode-status hidden" id="nativeModeStatus" role="status" aria-live="polite"></div>

    <div class="enhancements-section full-mode-only" role="group" aria-label="Audio enhancements">
      <div class="advanced-item" data-item-id="balance">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Balance: Slider mode (default) -->
        <div class="balance-row eq-slider-mode" role="group" aria-label="Audio balance and channel controls">
          <span class="balance-title">Balance</span>
          <span class="balance-label" id="balanceLabelLeft" aria-hidden="true">L</span>
          <input type="range" id="balanceSlider" min="-100" max="100" value="0" class="balance-slider" title="Drag to shift audio left or right" aria-label="Audio balance, left to right" aria-valuemin="-100" aria-valuemax="100" aria-valuenow="0">
          <span class="balance-label" id="balanceLabelRight" aria-hidden="true">R</span>
          <div class="balance-controls">
            <button class="balance-mode-btn active" id="stereoToggle" title="Stereo (separate L+R channels)" aria-label="Stereo mode" aria-pressed="true">S</button>
            <button class="balance-mode-btn" id="monoToggle" title="Mono (merge L+R channels)" aria-label="Mono mode" aria-pressed="false">M</button>
            <button class="balance-mode-btn" id="swapToggle" title="Swap left and right channels" aria-label="Swap left and right channels" aria-pressed="false">⇄</button>
            <button class="balance-reset-btn" id="balanceReset" title="Reset to center" aria-label="Reset balance to center">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
              </svg>
            </button>
          </div>
        </div>
        <!-- Balance: Preset mode (hidden by default) -->
        <div class="balance-row eq-presets-mode hidden" role="group" aria-label="Audio balance presets">
          <span class="balance-title">Balance</span>
          <div class="effect-buttons balance-presets">
            <button class="effect-btn" data-effect="balance" data-level="left" title="Pan audio left" aria-label="Pan audio left">Left</button>
            <button class="effect-btn" data-effect="balance" data-level="center" title="Center audio" aria-label="Center audio balance">Center</button>
            <button class="effect-btn" data-effect="balance" data-level="right" title="Pan audio right" aria-label="Pan audio right">Right</button>
          </div>
          <div class="balance-controls">
            <button class="balance-mode-btn active" id="stereoTogglePresets" title="Stereo (separate L+R channels)" aria-label="Stereo mode" aria-pressed="true">S</button>
            <button class="balance-mode-btn" id="monoTogglePresets" title="Mono (merge L+R channels)" aria-label="Mono mode" aria-pressed="false">M</button>
            <button class="balance-mode-btn" id="swapTogglePresets" title="Swap left and right channels" aria-label="Swap left and right channels" aria-pressed="false">⇄</button>
            <button class="balance-reset-btn" id="balanceResetPresets" title="Reset to center" aria-label="Reset balance to center">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="advanced-item" data-item-id="speed">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Speed: Preset buttons (default) -->
        <div class="effect-row eq-presets-mode" role="group" aria-label="Speed presets">
          <span class="effect-label" title="Adjust playback speed">Speed</span>
          <div class="effect-buttons combined">
            <button class="effect-btn cut high" data-effect="speed" data-level="slow-high" id="speedSlowHigh" title="Slow speed (0.25x)" aria-label="Speed slow high">0.25x</button>
            <button class="effect-btn cut medium" data-effect="speed" data-level="slow-medium" id="speedSlowMed" title="Slow speed (0.50x)" aria-label="Speed slow medium">0.50x</button>
            <button class="effect-btn cut low" data-effect="speed" data-level="slow-low" id="speedSlowLow" title="Slow speed (0.75x)" aria-label="Speed slow low">0.75x</button>
            <button class="effect-btn" data-effect="speed" data-level="off" title="Normal speed (1x)" aria-label="Speed off">1x</button>
            <button class="effect-btn low" data-effect="speed" data-level="fast-low" id="speedFastLow" title="Fast speed (1.25x)" aria-label="Speed fast low">1.25x</button>
            <button class="effect-btn medium" data-effect="speed" data-level="fast-medium" id="speedFastMed" title="Fast speed (1.50x)" aria-label="Speed fast medium">1.50x</button>
            <button class="effect-btn high" data-effect="speed" data-level="fast-high" id="speedFastHigh" title="Fast speed (2.00x)" aria-label="Speed fast high">2.00x</button>
          </div>
        </div>
        <!-- Speed: Slider mode (hidden by default) -->
        <div class="effect-row eq-slider-mode hidden" role="group" aria-label="Speed slider">
          <span class="effect-label" title="Adjust playback speed">Speed</span>
          <div class="eq-slider-container">
            <input type="range" id="speedSlider" min="0" max="100" value="50" step="1"
                   class="eq-slider speed-slider" aria-label="Playback speed" title="Speed: 1.00x">
            <span class="eq-slider-value" id="speedValue">1.00x</span>
          </div>
          <button class="eq-reset-btn" id="speedReset" title="Reset speed to 1x" aria-label="Reset speed">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="bass">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Bass: Preset buttons (default) -->
        <div class="effect-row eq-presets-mode" role="group" aria-label="Bass presets">
          <span class="effect-label" title="Boost or cut low frequencies">Bass</span>
          <div class="effect-buttons combined">
            <button class="effect-btn cut high" data-effect="bass" data-level="cut-high" id="bassCutHigh" title="Strong bass cut (-24 dB)" aria-label="Bass cut high">-24</button>
            <button class="effect-btn cut medium" data-effect="bass" data-level="cut-medium" id="bassCutMed" title="Medium bass cut (-12 dB)" aria-label="Bass cut medium">-12</button>
            <button class="effect-btn cut low" data-effect="bass" data-level="cut-low" id="bassCutLow" title="Light bass cut (-6 dB)" aria-label="Bass cut low">-6</button>
            <button class="effect-btn" data-effect="bass" data-level="off" title="No bass adjustment" aria-label="Bass off">Off</button>
            <button class="effect-btn low" data-effect="bass" data-level="low" id="bassLow" title="Light bass boost (+6 dB)" aria-label="Bass boost low">+6</button>
            <button class="effect-btn medium" data-effect="bass" data-level="medium" id="bassMed" title="Medium bass boost (+12 dB)" aria-label="Bass boost medium">+12</button>
            <button class="effect-btn high" data-effect="bass" data-level="high" id="bassHigh" title="Strong bass boost (+24 dB)" aria-label="Bass boost high">+24</button>
          </div>
        </div>
        <!-- Bass: Slider mode (hidden by default) -->
        <div class="effect-row eq-slider-mode hidden" role="group" aria-label="Bass slider">
          <span class="effect-label" title="Boost or cut low frequencies">Bass</span>
          <div class="eq-slider-container">
            <input type="range" id="bassSlider" class="eq-slider" min="-24" max="24" value="0" title="Adjust bass: -24 to +24 dB" aria-label="Bass level">
            <span class="eq-slider-value" id="bassSliderValue">0 dB</span>
          </div>
          <button class="eq-reset-btn" id="bassReset" title="Reset bass" aria-label="Reset bass to 0 dB">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="treble">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Treble: Preset buttons (default) -->
        <div class="effect-row eq-presets-mode" role="group" aria-label="Treble presets">
          <span class="effect-label" title="Boost or cut high frequencies">Treble</span>
          <div class="effect-buttons combined">
            <button class="effect-btn cut high" data-effect="treble" data-level="cut-high" id="trebleCutHigh" title="Strong treble cut (-24 dB)" aria-label="Treble cut high">-24</button>
            <button class="effect-btn cut medium" data-effect="treble" data-level="cut-medium" id="trebleCutMed" title="Medium treble cut (-12 dB)" aria-label="Treble cut medium">-12</button>
            <button class="effect-btn cut low" data-effect="treble" data-level="cut-low" id="trebleCutLow" title="Light treble cut (-6 dB)" aria-label="Treble cut low">-6</button>
            <button class="effect-btn" data-effect="treble" data-level="off" title="No treble adjustment" aria-label="Treble off">Off</button>
            <button class="effect-btn low" data-effect="treble" data-level="low" id="trebleLow" title="Light treble boost (+6 dB)" aria-label="Treble boost low">+6</button>
            <button class="effect-btn medium" data-effect="treble" data-level="medium" id="trebleMed" title="Medium treble boost (+12 dB)" aria-label="Treble boost medium">+12</button>
            <button class="effect-btn high" data-effect="treble" data-level="high" id="trebleHigh" title="Strong treble boost (+24 dB)" aria-label="Treble boost high">+24</button>
          </div>
        </div>
        <!-- Treble: Slider mode (hidden by default) -->
        <div class="effect-row eq-slider-mode hidden" role="group" aria-label="Treble slider">
          <span class="effect-label" title="Boost or cut high frequencies">Treble</span>
          <div class="eq-slider-container">
            <input type="range" id="trebleSlider" class="eq-slider" min="-24" max="24" value="0" title="Adjust treble: -24 to +24 dB" aria-label="Treble level">
            <span class="eq-slider-value" id="trebleSliderValue">0 dB</span>
          </div>
          <button class="eq-reset-btn" id="trebleReset" title="Reset treble" aria-label="Reset treble to 0 dB">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="voice">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Voice: Preset buttons (default) -->
        <div class="effect-row eq-presets-mode" role="group" aria-label="Voice boost presets">
          <span class="effect-label" title="Enhances vocal frequencies for clearer speech">Voice</span>
          <div class="effect-buttons">
            <button class="effect-btn" data-effect="voice" data-level="off" title="No voice enhancement" aria-label="Voice boost off">Off</button>
            <button class="effect-btn low" data-effect="voice" data-level="low" id="voiceLow" title="Subtle voice clarity (+4 dB)" aria-label="Voice boost low">+4dB</button>
            <button class="effect-btn medium" data-effect="voice" data-level="medium" id="voiceMed" title="Moderate voice boost (+10 dB)" aria-label="Voice boost medium">+10dB</button>
            <button class="effect-btn high" data-effect="voice" data-level="high" id="voiceHigh" title="Strong voice boost (+18 dB)" aria-label="Voice boost high">+18dB</button>
          </div>
        </div>
        <!-- Voice: Slider mode (hidden by default) -->
        <div class="effect-row eq-slider-mode hidden" role="group" aria-label="Voice slider">
          <span class="effect-label" title="Enhances vocal frequencies for clearer speech">Voice</span>
          <div class="eq-slider-container">
            <input type="range" id="voiceSlider" class="eq-slider voice-slider" min="0" max="18" value="0" title="Adjust voice clarity: 0 to +18 dB" aria-label="Voice level">
            <span class="eq-slider-value" id="voiceSliderValue">0 dB</span>
          </div>
          <button class="eq-reset-btn" id="voiceReset" title="Reset voice" aria-label="Reset voice to 0 dB">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="range">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Range: Preset buttons (default) -->
        <div class="effect-row eq-presets-mode" id="compressorRow" role="group" aria-label="Dynamic range presets">
          <span class="effect-label" title="Reduces volume differences between quiet and loud sounds">Range</span>
          <div class="effect-buttons">
            <button class="effect-btn" data-effect="compressor" data-level="off" title="No dynamic range compression" aria-label="Compressor off">Off</button>
            <button class="effect-btn low" data-effect="compressor" data-level="podcast" title="Light compression for clear speech and dialog" aria-label="Podcast compression preset">Podcast</button>
            <button class="effect-btn medium" data-effect="compressor" data-level="movie" title="Medium compression for balanced movie audio" aria-label="Movie compression preset">Movie</button>
            <button class="effect-btn high" data-effect="compressor" data-level="maximum" title="Heavy compression for maximum volume consistency" aria-label="Maximum compression preset">Max</button>
          </div>
        </div>
        <!-- Range: Slider mode (hidden by default) -->
        <div class="effect-row eq-slider-mode hidden" role="group" aria-label="Dynamic range slider">
          <span class="effect-label" title="Reduces volume differences between quiet and loud sounds">Range</span>
          <div class="eq-slider-container">
            <input type="range" id="compressorSlider" min="0" max="3" step="1" value="0"
                   class="eq-slider range-slider" aria-label="Dynamic range level" title="Range: Off">
            <span class="eq-slider-value range-value" id="compressorSliderValue">Off</span>
          </div>
          <button class="eq-reset-btn" id="compressorReset" title="Reset range to Off" aria-label="Reset range">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="output">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Output -->
        <div class="device-selector compact-row" role="group" aria-label="Audio output device selection">
          <span class="compact-label">Output</span>
          <select id="deviceSelect" class="device-select" title="Route this tab's audio to a specific device" aria-label="Select audio output device">
            <option value="">Default (System Audio)</option>
          </select>
          <button id="refreshDevices" class="refresh-btn" title="Refresh device list (requires permission)" aria-label="Refresh audio device list">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="advanced-item" data-item-id="siteRule">
        <div class="effects-divider" aria-hidden="true"></div>
        <!-- Site Rule -->
        <div class="add-rule-section compact-row" role="group" aria-label="Site rule creation">
          <span class="compact-label">Site Rule</span>
          <label class="domain-checkbox" title="Apply rule to all pages on this website">
            <input type="checkbox" id="ruleDomainCheckbox" aria-label="Apply rule to entire domain">
            <span>Entire Domain</span>
          </label>
          <button id="addSiteRuleBtn" class="add-rule-btn compact" title="Create a site rule with current settings" aria-label="Add site rule with current settings">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Add
          </button>
          <div id="ruleStatus" class="rule-status compact" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- Global status message area for error feedback -->
    <div id="statusMessage" class="status-message" role="status" aria-live="polite"></div>

    <!-- Cleanup button for old rules (hidden by default, shown when storage quota warning) -->
    <button id="cleanupRulesBtn" class="cleanup-rules-btn hidden" title="Remove site rules unused for 90+ days" aria-label="Clean up old site rules">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Clean Up Old Rules
    </button>

    <!-- Tab Capture button for Chrome (hidden by default, shown when audio not accessible) -->
    <button id="enableTabCaptureBtn" class="enable-tabcapture-btn hidden" title="Enable Tab Capture for this site" aria-label="Enable Tab Capture">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Enable Tab Capture
    </button>

    <!-- Disable Mode button for Firefox (hidden by default, shown when audio not accessible) -->
    <button id="enableNativeModeBtn" class="enable-native-mode-btn hidden" title="Disable audio processing for this site" aria-label="Disable audio processing">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Disable Audio Processing
    </button>

    <!-- Valentine Easter Egg Overlay (hidden by default) -->
    <div class="valentine-overlay hidden" id="valentineOverlay" role="dialog" aria-label="A special message">
      <div class="valentine-content">
        <div class="valentine-hearts" aria-hidden="true">&#10084; &#10084; &#10084;</div>
        <p class="valentine-message">My precious. My rider. My always. Mother of dragons, love of every lifetime.</p>
        <p class="valentine-message">Happy Valentine's Day.</p>
        <p class="valentine-signature">JB+MB &bull; 2026</p>
        <div class="valentine-hearts" aria-hidden="true">&#10084; &#10084; &#10084;</div>
        <button class="valentine-dismiss" id="valentineDismiss" aria-label="Close message">&#10084;</button>
      </div>
    </div>

    <!-- Keyboard Shortcuts Footer -->
    <div class="shortcuts-footer" id="shortcutsFooter" aria-label="Keyboard shortcuts">
      <div class="shortcuts-footer-row">
        <span class="shortcut-action">Vol Up</span>
        <span class="shortcut-key" id="shortcutsVolUp">Alt+Shift+↑</span>
      </div>
      <div class="shortcuts-footer-row">
        <span class="shortcut-action">Vol Down</span>
        <span class="shortcut-key" id="shortcutsVolDown">Alt+Shift+↓</span>
      </div>
      <div class="shortcuts-footer-row">
        <span class="shortcut-action">Mute</span>
        <span class="shortcut-key" id="shortcutsMute">Alt+Shift+M</span>
      </div>
    </div>

  </div>

  <!-- Shared utilities - must load first -->
  <script src="../shared/browser-api.js"></script>
  <script src="../shared/constants.js"></script>
  <script src="../shared/validation.js"></script>
  <!-- Modular popup scripts - load order matters -->
  <script src="popup-core.js"></script>
  <script src="popup-effects.js"></script>
  <script src="popup-devices.js"></script>
  <script src="popup-volume.js"></script>
  <script src="popup-visualizer.js"></script>
  <script src="popup-seekbar.js"></script>
  <script src="popup-tabs.js"></script>
</body>
</html>
